<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>전국 학교 근처 도서관 검색</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            background-color: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
            margin: 0;
        }

        form {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        input[type="text"], input[type="number"] {
            width: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #map {
            width: 100%;
            height: 400px;
        }

        #resultsTable {
            width: 90%;
            margin: 20px auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 12px;
        }

        th {
            background-color: #f4f4f4;
            text-align: center;
        }
    </style>
    <!-- 네이버 지도 API -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=1igppkmtqd"></script>
</head>
<body>
    <h1>전국 학교 근처 도서관 검색</h1>
    <form id="searchForm">
        <input type="text" id="queryInput" placeholder="학교 이름을 입력하세요" required>
        <input type="number" id="distanceInput" placeholder="거리를 입력하세요 (숫자)" required>
        <button type="submit">검색</button>
    </form>

    <!-- 지도 표시 영역 -->
    <div id="map"></div>

    <!-- 검색 결과 테이블 -->
    <div id="resultsTable"></div>

    <script>
        const apiUrl = "http://api.kcisa.kr/openapi/API_CNV_065/request";
        const serviceKey = "b4ff56c8-b1eb-4fd5-a14f-b934d62cef85";

        let map; // 지도 객체
        let markers = []; // 마커 배열

        // 지도 초기화
        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.3595704, 127.105399), // 초기 지도 중심 (서울)
                zoom: 10 // 초기 줌 레벨
            });
        }

        // 검색 이벤트 처리
        document.getElementById('searchForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const query = document.getElementById('queryInput').value; // 검색어
            const distance = document.getElementById('distanceInput').value; // 거리
            const resultsContainer = document.getElementById('resultsTable');

            // 검색 결과 초기화
            resultsContainer.innerHTML = "";

            // API 요청 URL 생성
            const url = `${apiUrl}?serviceKey=${serviceKey}&numOfRows=10&pageNo=1&schNm=${encodeURIComponent(query)}&dist=${distance}&type=xml`;

            // API 호출
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP 오류 발생: ${response.status}`);
                    }
                    return response.text();
                })
                .then(xmlText => {
                    // XML 파싱
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    const items = xmlDoc.getElementsByTagName("item");

                    // 기존 마커 삭제
                    clearMarkers();

                    // 결과 처리
                    if (items.length > 0) {
                        // 테이블 생성
                        const table = document.createElement("table");

                        // 테이블 헤더
                        const thead = document.createElement("thead");
                        const headerRow = document.createElement("tr");
                        const headers = ["번호", "학교", "도서관", "주소", "운영일", "열람좌석"];
                        headers.forEach(header => {
                            const th = document.createElement("th");
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        // 테이블 본문
                        const tbody = document.createElement("tbody");

                        Array.from(items).forEach((item, index) => {
                            const row = document.createElement("tr");

                            // 테이블 데이터
                            const schoolName = item.getElementsByTagName("schNm")[0]?.textContent || "학교 정보 없음";
                            const libraryName = item.getElementsByTagName("fcltyNm")[0]?.textContent || "도서관 정보 없음";
                            const address = item.getElementsByTagName("fcltyRoadNmAddr")[0]?.textContent || "주소 정보 없음";
                            const description = item.getElementsByTagName("description")[0]?.textContent || "운영일 정보 없음";
                            const subDescription = item.getElementsByTagName("subDescription")[0]?.textContent || "열람 좌석 정보 없음";
                            const lat = parseFloat(item.getElementsByTagName("latitude")[0]?.textContent || "0");
                            const lng = parseFloat(item.getElementsByTagName("longitude")[0]?.textContent || "0");

                            // 테이블 행 추가
                            const data = [index + 1, schoolName, libraryName, address, description, subDescription];
                            data.forEach(cellData => {
                                const td = document.createElement("td");
                                td.textContent = cellData;
                                row.appendChild(td);
                            });
                            tbody.appendChild(row);

                            // 지도에 핀 추가
                            if (!isNaN(lat) && !isNaN(lng)) {
                                const marker = new naver.maps.Marker({
                                    position: new naver.maps.LatLng(lat, lng),
                                    map: map,
                                    icon: {
                                        content: `<div style="width:20px;height:20px;background-color:${getRandomColor()};border-radius:50%;"></div>`,
                                    },
                                    title: libraryName
                                });

                                markers.push(marker);

                                // 마커 클릭 이벤트
                                const infoWindow = new naver.maps.InfoWindow({
                                    content: `<div><strong>${libraryName}</strong><br>${address}</div>`,
                                });

                                naver.maps.Event.addListener(marker, "click", () => {
                                    infoWindow.open(map, marker);
                                });
                            }
                        });

                        table.appendChild(tbody);
                        resultsContainer.appendChild(table);
                    } else {
                        resultsContainer.innerHTML = "<p>검색 결과가 없습니다.</p>";
                    }
                })
                .catch(error => {
                    console.error("오류 발생:", error);
                    resultsContainer.innerHTML = `<p>오류 발생: ${error.message}</p>`;
                });
        });

        // 마커 초기화 함수
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        // 랜덤 색상 생성 함수
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 지도 초기화
        initMap();
    </script>
</body>
</html>
